<!doctype html><html lang=zh><head><meta name=viewport content="width=device-width,initial-scale=1"><title>用 serverless 开发一个 Chat 机器人提醒</title>
<meta charset=utf-8><meta name=description content="Ladder@本文描述了笔者基于 Serverless 技术开发 Chat 机器人提醒应用的全流程，记录了开发遇到的一些问题和技术选择的思考。在开发完成后，有小伙伴想知道一些技术细节来做二次开发，于是有了这篇分享。"><meta name=author content="Guangzheng Li"><link rel=canonical href=https://guangzhengli.com/blog/zh/webhook-with-serverless/><meta name=google-site-verification content="RL6kP6-6yjRPyYGLeqBQ2JIX6QQAz7A6gHZb7bHlZnU"><link rel=alternate type=application/rss+xml href=https://guangzhengli.com//index.xml title=GuangzhengLi><script async src="https://www.googletagmanager.com/gtag/js?id=G-7E4JNTL3ES"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7E4JNTL3ES",{anonymize_ip:!1})}</script><script async defer data-website-id=24349452-bff6-4e96-93bf-6c764e191b26 src=https://umami-ochre-nu.vercel.app/hugo-ladder.js></script><meta property="og:title" content="用 serverless 开发一个 Chat 机器人提醒"><meta property="og:description" content="本文描述了笔者基于 Serverless 技术开发 Chat 机器人提醒应用的全流程，记录了开发遇到的一些问题和技术选择的思考。在开发完成后，有小伙伴想知道一些技术细节来做二次开发，于是有了这篇分享。"><meta property="og:type" content="article"><meta property="og:url" content="https://guangzhengli.com/blog/zh/webhook-with-serverless/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-12-19T00:00:00+00:00"><meta property="article:modified_time" content="2022-12-19T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="用 serverless 开发一个 Chat 机器人提醒"><meta name=twitter:description content="本文描述了笔者基于 Serverless 技术开发 Chat 机器人提醒应用的全流程，记录了开发遇到的一些问题和技术选择的思考。在开发完成后，有小伙伴想知道一些技术细节来做二次开发，于是有了这篇分享。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://guangzhengli.com/blog/"},{"@type":"ListItem","position":2,"name":"用 serverless 开发一个 Chat 机器人提醒","item":"https://guangzhengli.com/blog/zh/webhook-with-serverless/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"用 serverless 开发一个 Chat 机器人提醒","name":"用 serverless 开发一个 Chat 机器人提醒","description":"本文描述了笔者基于 Serverless 技术开发 Chat 机器人提醒应用的全流程，记录了开发遇到的一些问题和技术选择的思考。在开发完成后，有小伙伴想知道一些技术细节来做二次开发，于是有了这篇分享。\n","keywords":["serverless","cloudflare","worker"],"articleBody":"本文描述了笔者基于 Serverless 技术开发 Chat 机器人提醒应用的全流程，记录了开发遇到的一些问题和技术选择的思考。在开发完成后，有小伙伴想知道一些技术细节来做二次开发，于是有了这篇分享。\n业务需求 最开始想开发一个 Chat 机器人提醒，是因为当时项目上的人很多，每天都需要轮换站会和 Code Review 的 Owner，导致每天的站会和 Code Review 时，都需要先花费几分钟时间确认今天的站会 Owner 是谁，接着确定后还要准备 Share 屏幕，最后还需要手动维护项目人员轮换名单，会议的体验很差。为了解决以下的常规会议的痛点：\n杜绝会议开始时常见的灵魂问题，今天的 owner 是谁 缩短会议的准备时间，预防 owner 没有提前去会议室准备的情况 预防到时间后，有人忘记参加会议，需要人手动提醒 所以有了第一个想法💡，即做一个自动提醒的机器人，包括有如下功能来缓解痛点：\n定时发送消息\n在工作日时，在会议开始前5分钟时，发送提醒文本。 在周末，不发送消息 当发送文本消息时，文本包括会议地址，owner，和会议时间。\n定时轮换 owner 名单，定时可配置，例如每天轮换，或者每周轮换。\n例如站会的提醒效果图如下所示：\n技术选型 在业务需求确定后，首先需要判断系统是否要求高可用、可扩展或者性能是否有要求。在这个用例中，这些技术要求都可以不要，毕竟只是自用的辅助手段，就算偶尔挂了也无所谓。这也为后续的技术选型打开了道路。\n其次需要预估该功能的资源需求，该功能每天定时发送的请求给 Chat 一般不超过 10 条，所以假设 Request / Day = 10。存储的话需要存储会议的轮换名单，名字占用很少，所以预估最大就是 1KB Size of storage = 1KB。\n得到技术需求和资源预估后，就能在后续技术选型时有比较明确的方向。首先列出几个可以完成这个功能的方案：\nLocal machine + Disk Cloud VM + Disk Serverless AWS Lambda + DynamoDB Azure Function + CosmosDB Cloudflare Worker + Worker KV Local machine \u0026 Disk 首先我们尝试使用 Python 或者任意语言在本地环境进行 Schedule 定时，直接使用本地环境进行部署运行，因为不要求高可用，偶尔的服务宕机可以接受，所以在追求最简单的方式来实现也未尝不可。\n方案是使用 Python schedule 库或者任意语言定时发送消息，使用本地文件来存储轮换名单。优点是在本地部署调试和管理起来比较方便，不需要额外的花费，缺点是必须保证 Python 定时进程存活和网络可用，一旦电脑关机或者你请假时就不可用了🤔。如下代码 Demo 是从同目录下 code_review.txt 文件中拿到当前会议 Owner 名字和下一个 Owner 的名字，一起发送 Code Review 提醒给企业微信。\nfrom posixpath import split from corpwechatbot.chatbot import CorpWechatBot import schedule import time from datetime import datetime message = \"\"\"Code Review马上开始啦 ----------------------------- ZOOM URL: https://xxx.zoom.us/j/xxx ID: xxx Passcode: xxx ----------------------------- 今天的 host 是: {current_owner} 明天的 host 是: {next_owner} \"\"\" def get_code_review_owner_name(): f = open('code_review.txt', 'r', encoding='utf-8') name_array = f.read().split() current_owner = name_array[0] next_owner = name_array[1] name_array.insert(len(name_array), name_array.pop(0)) write_txt = ' '.join(name_array) f = open('code_review.txt', 'w', encoding='utf-8') f.write(write_txt) f.close return current_owner, next_owner def send_notification(): current_owner, next_owner = get_code_review_owner_name() send_message = message.format(current_owner=current_owner, next_owner=next_owner) bot = CorpWechatBot(key='key providerd by wechat work') bot.send_text(content=send_message, mentioned_list=['@all']) schedule.every().monday.at(\"17:00\").do(send_notification) schedule.every().tuesday.at(\"17:00\").do(send_notification) schedule.every().wednesday.at(\"17:00\").do(send_notification) schedule.every().thursday.at(\"17:00\").do(send_notification) schedule.every().friday.at(\"17:00\").do(send_notification) while True: schedule.run_pending() time.sleep(1) Cloud VM \u0026 Disk 第二个方案使用云服务器来运行定时进程，和第一个方案使用的技术栈和代码相同，可以用任意语言定时发送消息，只需要注意服务器时区问题即可。区别在于该方案需要购买云服务器来部署，不用在意关机或者不可用问题，但是在目前这种技术需求和资源需求下，去买一个云服务器完成该功能肯定是不划算的。\n以上两种方案都有各自的优缺点，一种是可用性不高，一种是费用高，所以接下来最后一种 Serverless 方案，即是可以解决这两种问题的方案，也是我们今天主要需要讲的方案。\nServerless 最后一种也是今天主要聊的方案，即使用无服务器计算的方式来完成定时计算，发送消息给 Chat Webhook 服务器。\n无服务器计算（serverless computing），是一种由云服务商（AWS，Azure 或 Cloudflare）负责通过动态分配资源来执行一段代码的执行模型，并且仅收取运行代码所使用资源的费用。该代码通常运行在无状态的容器中，能够被包括HTTP请求、调度事件（cron任务）等各种事件触发并运行。因为代码运行在无状态的容器中，所以无法存储数据，对此云服务商提供了不同类型的存储服务和 SDK，可以无缝衔接对应厂商提供的 Serverless。\n在之前分析技术需求时，我们了解到该应用的 Request / Day \u003c 10，每天所需的 CPU 时间很少，所以使用 serverless 来执行定时发送消息的任务非常的合适。主要原因一是基础设施由云服务商提供，可用性方面有一定的保证，二是价格非常便宜(这也是 serverless 普及的最重要的原因)。下面是各大云服务商提供的每月免费额度，我们这个项目每个月用不到免费额度的万分之一。\nAWS Lamda: 128M + 3,200,000S / 1 month Azure Function: 1 million requests / 1 month Cloudflare Workers: 100,000 requests / 1 month 由于 serverless 是不提供存储功能的，所以需要存储人员轮换名单的话，光靠 serverless 的无状态容器就不够用了。需要用到各大云服务商提出的不同类型存储服务，比如有关系型数据库、NoSQL、KV，甚至是基于 SQLite 的 serverless database，例如 Cloudflare D1。回顾我们需要存储的数据，只是简单的团队人员名单，所以无需使用结构化的数据，只需要很简单的 KV 存储即可。如下面几个 KV 服务和其对应的云厂商的免费额度：\nAWS DynamoDB：25GB Storage + 1G Networks Azure CosmosDB: 1000 request per-second + 25GB storage Cloudflare Workers KV: 1GB storage 由于 Cloudflare 原生提供绑定域名和提供 serverless database，所以笔者比较喜欢使用 Cloudflare Workers (不过可用性方面个人认为不如 AWS，偶尔会定时无效)。这里就以 Cloudflare Workers 为例展示功能代码，代码主要分为两个 serverless application，也就是两个定时任务，一是定时发送消息给 Chat 提供的 webhook 地址，另一个是定时轮换主持会议的 owner 名单。\n首先是定时发送消息给 Chat 提供的 webhook 地址，从 KV 中获取当前的会议 Owner，会议地址和消息，通过获取配置的 webhook 地址发送给对应的 Chat（企业微信或者 Google Chat）。\nimport { send_google_chat_message } from \"./google_chat_notificaiton\"; import { send_wework_chat_message } from \"./wework_chat_notificaiton\"; export default { async scheduled(controller, env, ctx) { var standup_owner_name = await get_owner_name(env, env.KV_STANDUP_OWNER_NAMES); var message = `今日的站会马上开始!!!\\n今日站会 owner 是: ${standup_owner_name}\\n会议地址是: https://zoom.us/j/xxxx`; if (env.MESSAGE_TYPE == 'GoogleChat'){ send_google_chat_message(env, message); } else if(env.MESSAGE_TYPE == 'WeworkChat') { send_wework_chat_message(env, message); } }, }; async function get_owner_name(env, type) { var namesString = await env.notification_namespace.get(type); var names = namesString.split(','); return names[0]; } 二是定时轮换人员名单，这里主要是因为 owner 人员的轮换和会议主持时间可能不同步，例如每周轮换一次 Owner，明天发送 owner 主持的消息，所以需要单独的一个定时。下面代码实例展示周五发送轮换 owner 的消息。从 KV 中获取下一个 onwer 列表，轮换名单，并且 push 到 KV 中以便后续发送会议消息时拿到 owner 名单。\nimport { send_google_chat_message } from \"./google_chat_notificaiton\"; import { send_wework_chat_message } from \"./wework_chat_notificaiton\"; export default { async scheduled(controller, env, ctx) { var next_standup_owner_name = await getAndRotateOwners(env, env.KV_STANDUP_OWNER_NAMES); var message = `Happy Friday! 别忘记填写 timecard 哦!!!\\n下周站会 owner 是: ${next_standup_owner_name}`; if (env.MESSAGE_TYPE == 'GoogleChat'){ send_google_chat_message(env, message); } else if(env.MESSAGE_TYPE == 'WeworkChat') { send_wework_chat_message(env, message); } }, }; async function getAndRotateOwners(env, type) { var namesString = await env.notification_namespace.get(type); var names = namesString.split(','); names.push(names.shift()); var storeNameString = names.join(','); await env.notification_namespace.put(type, storeNameString); return names[0]; } 完整的项目代码放在这个 仓库 👈\n总结 回顾整个开发流程，我们能很轻易的感受到 serverless 的易用性和潜力，像类似于 WebHook、数据统计分析、Trigger 及定时任务和 Chat 机器人等功能，借用于 serverless 可以轻易的实现和部署，完成系统的原型设计和想法的闭环。近几年业界也在不断完善 serverless 的开发流程和核心缺陷，例如 JVM 冷启动问题，serverless 观测和调试增强，数据库 serverless 化如wunderbase，Neon，planetscale，D1 等项目。假以时日，当这些问题慢慢解决和优化，serverless 广阔的前景和强大将刷新人们的认知。\nReference https://sst.dev/chapters/zh/what-is-serverless.html https://blog.cloudflare.com/introducing-d1/ https://aws.amazon.com/free/ https://azure.microsoft.com/en-us/pricing/free-services/ https://www.infoq.com/news/2022/12/aws-lambda-snapstart-accelerate/ https://github.com/wundergraph/wunderbase https://www.sqlite.org/serverless.html https://github.com/neondatabase/neon ","wordCount":"2744","inLanguage":"zh","datePublished":"2022-12-19T00:00:00Z","dateModified":"2022-12-19T00:00:00Z","author":{"@type":"Person","name":"Guangzheng Li"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://guangzhengli.com/blog/zh/webhook-with-serverless/"},"publisher":{"@type":"Organization","name":"GuangzhengLi","logo":{"@type":"ImageObject","url":"https://guangzhengli.com/favicon.ico"}}}</script><link rel=icon href=/images/avatar.ico sizes=16x16><link rel=apple-touch-icon href=/images/avatar.ico><link rel=manifest href=/images/avatar.ico><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.ff1bc260fafbfb440e10194d7d06d57eb5e85eed11d12d06255581262664204e.css integrity="sha256-/xvCYPr7+0QOEBlNfQbVfrXoXu0R0S0GJVWBJiZkIE4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.894ca9c68afab956438c4926a0dc7f5293e04e08595bd27abdb123e94801f684.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>主页
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/blog>文章</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/art>即兴</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>历史文章</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/guestbook>留言板</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=https://analytics.guangzhengli.com/share/o3zAba1V/guangzhengli>网站统计</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/guangzhengli><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://twitter.com/iguangzhengli><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li><li class="navigation-item navigation-language"><a href=https://guangzhengli.com/en/>EN</a></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>用 serverless 开发一个 Chat 机器人提醒</h1></header><p><small>2022年12月19日&nbsp;· 2744 字&nbsp;· 6 分钟</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#业务需求>业务需求</a></li><li><a href=#技术选型>技术选型</a></li><li><a href=#local-machine--disk>Local machine & Disk</a><ul><li><a href=#cloud-vm--disk>Cloud VM & Disk</a></li></ul></li><li><a href=#serverless>Serverless</a></li><li><a href=#总结>总结</a></li><li><a href=#reference>Reference</a></li></ul></nav></div><section class=blog-content><p>本文描述了笔者基于 Serverless 技术开发 Chat 机器人提醒应用的全流程，记录了开发遇到的一些问题和技术选择的思考。在开发完成后，有小伙伴想知道一些技术细节来做二次开发，于是有了这篇分享。</p><h2 id=业务需求>业务需求</h2><p>最开始想开发一个 Chat 机器人提醒，是因为当时项目上的人很多，每天都需要轮换站会和 Code Review 的 Owner，导致每天的站会和 Code Review 时，都需要先花费几分钟时间确认今天的站会 Owner 是谁，接着确定后还要准备 Share 屏幕，最后还需要手动维护项目人员轮换名单，会议的体验很差。为了解决以下的常规会议的痛点：</p><ul><li>杜绝会议开始时常见的灵魂问题，今天的 owner 是谁</li><li>缩短会议的准备时间，预防 owner 没有提前去会议室准备的情况</li><li>预防到时间后，有人忘记参加会议，需要人手动提醒</li></ul><p>所以有了第一个想法💡，即做一个自动提醒的机器人，包括有如下功能来缓解痛点：</p><ul><li><p>定时发送消息</p><ul><li>在工作日时，在会议开始前5分钟时，发送提醒文本。</li><li>在周末，不发送消息</li></ul></li><li><p>当发送文本消息时，文本包括会议地址，owner，和会议时间。</p></li><li><p>定时轮换 owner 名单，定时可配置，例如每天轮换，或者每周轮换。</p></li></ul><p>例如站会的提醒效果图如下所示：</p><p><img src=https://storage.guangzhengli.com/images/screenshotr_2023-2-19T17-12-28.png alt=screenshotr_2023-2-19T17-12-28></p><h2 id=技术选型>技术选型</h2><p>在业务需求确定后，首先需要判断系统是否要求高可用、可扩展或者性能是否有要求。在这个用例中，这些技术要求都可以不要，毕竟只是自用的辅助手段，就算偶尔挂了也无所谓。这也为后续的技术选型打开了道路。</p><p>其次需要预估该功能的资源需求，该功能每天定时发送的请求给 Chat 一般不超过 10 条，所以假设 <code>Request / Day = 10</code>。存储的话需要存储会议的轮换名单，名字占用很少，所以预估最大就是 1KB <code>Size of storage = 1KB</code>。</p><p>得到技术需求和资源预估后，就能在后续技术选型时有比较明确的方向。首先列出几个可以完成这个功能的方案：</p><ul><li>Local machine + Disk</li><li>Cloud VM + Disk</li><li>Serverless<ul><li>AWS Lambda + DynamoDB</li><li>Azure Function + CosmosDB</li><li>Cloudflare Worker + Worker KV</li></ul></li></ul><h2 id=local-machine--disk>Local machine & Disk</h2><p>首先我们尝试使用 Python 或者任意语言在本地环境进行 Schedule 定时，直接使用本地环境进行部署运行，因为不要求高可用，偶尔的服务宕机可以接受，所以在追求最简单的方式来实现也未尝不可。</p><p>方案是使用 Python schedule 库或者任意语言定时发送消息，使用本地文件来存储轮换名单。优点是在本地部署调试和管理起来比较方便，不需要额外的花费，缺点是必须保证 Python 定时进程存活和网络可用，一旦电脑关机或者你请假时就不可用了🤔。如下代码 Demo 是从同目录下 <code>code_review.txt</code> 文件中拿到当前会议 Owner 名字和下一个 Owner 的名字，一起发送 Code Review 提醒给企业微信。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> posixpath <span style=color:#f92672>import</span> split
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> corpwechatbot.chatbot <span style=color:#f92672>import</span> CorpWechatBot
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> schedule
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> datetime <span style=color:#f92672>import</span> datetime
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;Code Review马上开始啦
</span></span></span><span style=display:flex><span><span style=color:#e6db74>-----------------------------
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ZOOM URL: https://xxx.zoom.us/j/xxx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ID: xxx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Passcode: xxx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>-----------------------------
</span></span></span><span style=display:flex><span><span style=color:#e6db74>今天的 host 是: </span><span style=color:#e6db74>{current_owner}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>明天的 host 是: </span><span style=color:#e6db74>{next_owner}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_code_review_owner_name</span>():
</span></span><span style=display:flex><span>    f <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#39;code_review.txt&#39;</span>, <span style=color:#e6db74>&#39;r&#39;</span>, encoding<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>    name_array <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read()<span style=color:#f92672>.</span>split()
</span></span><span style=display:flex><span>    current_owner <span style=color:#f92672>=</span> name_array[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>    next_owner <span style=color:#f92672>=</span> name_array[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    name_array<span style=color:#f92672>.</span>insert(len(name_array), name_array<span style=color:#f92672>.</span>pop(<span style=color:#ae81ff>0</span>))
</span></span><span style=display:flex><span>    write_txt <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39; &#39;</span><span style=color:#f92672>.</span>join(name_array)
</span></span><span style=display:flex><span>    f <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#39;code_review.txt&#39;</span>, <span style=color:#e6db74>&#39;w&#39;</span>, encoding<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>    f<span style=color:#f92672>.</span>write(write_txt)
</span></span><span style=display:flex><span>    f<span style=color:#f92672>.</span>close
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> current_owner, next_owner
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_notification</span>():
</span></span><span style=display:flex><span>    current_owner, next_owner <span style=color:#f92672>=</span> get_code_review_owner_name()
</span></span><span style=display:flex><span>    send_message <span style=color:#f92672>=</span> message<span style=color:#f92672>.</span>format(current_owner<span style=color:#f92672>=</span>current_owner, next_owner<span style=color:#f92672>=</span>next_owner)
</span></span><span style=display:flex><span>    bot <span style=color:#f92672>=</span> CorpWechatBot(key<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;key providerd by wechat work&#39;</span>)
</span></span><span style=display:flex><span>    bot<span style=color:#f92672>.</span>send_text(content<span style=color:#f92672>=</span>send_message, mentioned_list<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;@all&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>schedule<span style=color:#f92672>.</span>every()<span style=color:#f92672>.</span>monday<span style=color:#f92672>.</span>at(<span style=color:#e6db74>&#34;17:00&#34;</span>)<span style=color:#f92672>.</span>do(send_notification)
</span></span><span style=display:flex><span>schedule<span style=color:#f92672>.</span>every()<span style=color:#f92672>.</span>tuesday<span style=color:#f92672>.</span>at(<span style=color:#e6db74>&#34;17:00&#34;</span>)<span style=color:#f92672>.</span>do(send_notification)
</span></span><span style=display:flex><span>schedule<span style=color:#f92672>.</span>every()<span style=color:#f92672>.</span>wednesday<span style=color:#f92672>.</span>at(<span style=color:#e6db74>&#34;17:00&#34;</span>)<span style=color:#f92672>.</span>do(send_notification)
</span></span><span style=display:flex><span>schedule<span style=color:#f92672>.</span>every()<span style=color:#f92672>.</span>thursday<span style=color:#f92672>.</span>at(<span style=color:#e6db74>&#34;17:00&#34;</span>)<span style=color:#f92672>.</span>do(send_notification)
</span></span><span style=display:flex><span>schedule<span style=color:#f92672>.</span>every()<span style=color:#f92672>.</span>friday<span style=color:#f92672>.</span>at(<span style=color:#e6db74>&#34;17:00&#34;</span>)<span style=color:#f92672>.</span>do(send_notification)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>    schedule<span style=color:#f92672>.</span>run_pending()
</span></span><span style=display:flex><span>    time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>1</span>)
</span></span></code></pre></div><h3 id=cloud-vm--disk>Cloud VM & Disk</h3><p>第二个方案使用云服务器来运行定时进程，和第一个方案使用的技术栈和代码相同，可以用任意语言定时发送消息，只需要注意服务器时区问题即可。区别在于该方案需要购买云服务器来部署，不用在意关机或者不可用问题，但是在目前这种技术需求和资源需求下，去买一个云服务器完成该功能肯定是不划算的。</p><p>以上两种方案都有各自的优缺点，一种是可用性不高，一种是费用高，所以接下来最后一种 Serverless 方案，即是可以解决这两种问题的方案，也是我们今天主要需要讲的方案。</p><h2 id=serverless>Serverless</h2><p>最后一种也是今天主要聊的方案，即使用无服务器计算的方式来完成定时计算，发送消息给 Chat Webhook 服务器。</p><p>无服务器计算（serverless computing），是一种由云服务商（AWS，Azure 或 Cloudflare）负责通过动态分配资源来执行一段代码的执行模型，并且仅收取运行代码所使用资源的费用。该代码通常运行在无状态的容器中，能够被包括HTTP请求、调度事件（cron任务）等各种事件触发并运行。因为代码运行在无状态的容器中，所以无法存储数据，对此云服务商提供了不同类型的存储服务和 SDK，可以无缝衔接对应厂商提供的 Serverless。</p><p>在之前分析技术需求时，我们了解到该应用的 <code>Request / Day &lt; 10</code>，每天所需的 CPU 时间很少，所以使用 serverless 来执行定时发送消息的任务非常的合适。主要原因一是基础设施由云服务商提供，可用性方面有一定的保证，二是价格非常便宜(这也是 serverless 普及的最重要的原因)。下面是各大云服务商提供的每月免费额度，我们这个项目每个月用不到免费额度的万分之一。</p><ul><li>AWS Lamda: 128M + 3,200,000S / 1 month</li><li>Azure Function: 1 million requests / 1 month</li><li>Cloudflare Workers: 100,000 requests / 1 month</li></ul><p>由于 serverless 是不提供存储功能的，所以需要存储人员轮换名单的话，光靠 serverless 的无状态容器就不够用了。需要用到各大云服务商提出的不同类型存储服务，比如有关系型数据库、NoSQL、KV，甚至是基于 SQLite 的 <code>serverless database</code>，例如 <a href=https://blog.cloudflare.com/introducing-d1/>Cloudflare D1</a>。回顾我们需要存储的数据，只是简单的团队人员名单，所以无需使用结构化的数据，只需要很简单的 KV 存储即可。如下面几个 KV 服务和其对应的云厂商的免费额度：</p><ul><li>AWS DynamoDB：25GB Storage + 1G Networks</li><li>Azure CosmosDB: 1000 request per-second + 25GB storage</li><li>Cloudflare Workers KV: 1GB storage</li></ul><p>由于 Cloudflare 原生提供绑定域名和提供 <code>serverless database</code>，所以笔者比较喜欢使用 Cloudflare Workers (不过可用性方面个人认为不如 AWS，偶尔会定时无效)。这里就以 Cloudflare Workers 为例展示功能代码，代码主要分为两个 <code>serverless application</code>，也就是两个定时任务，一是定时发送消息给 Chat 提供的 webhook 地址，另一个是定时轮换主持会议的 owner 名单。</p><p>首先是定时发送消息给 Chat 提供的 webhook 地址，从 KV 中获取当前的会议 Owner，会议地址和消息，通过获取配置的 webhook 地址发送给对应的 Chat（企业微信或者 Google Chat）。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>send_google_chat_message</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./google_chat_notificaiton&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>send_wework_chat_message</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./wework_chat_notificaiton&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>async</span> <span style=color:#a6e22e>scheduled</span>(<span style=color:#a6e22e>controller</span>, <span style=color:#a6e22e>env</span>, <span style=color:#a6e22e>ctx</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>standup_owner_name</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>get_owner_name</span>(<span style=color:#a6e22e>env</span>, <span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>KV_STANDUP_OWNER_NAMES</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>message</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`今日的站会马上开始!!!\n今日站会 owner 是: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>standup_owner_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\n会议地址是: https://zoom.us/j/xxxx`</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>MESSAGE_TYPE</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;GoogleChat&#39;</span>){
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>send_google_chat_message</span>(<span style=color:#a6e22e>env</span>, <span style=color:#a6e22e>message</span>);
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>MESSAGE_TYPE</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;WeworkChat&#39;</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>send_wework_chat_message</span>(<span style=color:#a6e22e>env</span>, <span style=color:#a6e22e>message</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>get_owner_name</span>(<span style=color:#a6e22e>env</span>, <span style=color:#a6e22e>type</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>namesString</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>notification_namespace</span>.<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>type</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>names</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>namesString</span>.<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#39;,&#39;</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>names</span>[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>二是定时轮换人员名单，这里主要是因为 owner 人员的轮换和会议主持时间可能不同步，例如每周轮换一次 Owner，明天发送 owner 主持的消息，所以需要单独的一个定时。下面代码实例展示周五发送轮换 owner 的消息。从 KV 中获取下一个 onwer 列表，轮换名单，并且 push 到 KV 中以便后续发送会议消息时拿到 owner 名单。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>send_google_chat_message</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./google_chat_notificaiton&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>send_wework_chat_message</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./wework_chat_notificaiton&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>async</span> <span style=color:#a6e22e>scheduled</span>(<span style=color:#a6e22e>controller</span>, <span style=color:#a6e22e>env</span>, <span style=color:#a6e22e>ctx</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>next_standup_owner_name</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>getAndRotateOwners</span>(<span style=color:#a6e22e>env</span>, <span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>KV_STANDUP_OWNER_NAMES</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>message</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`Happy Friday! 别忘记填写 timecard 哦!!!\n下周站会 owner 是: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>next_standup_owner_name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>MESSAGE_TYPE</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;GoogleChat&#39;</span>){
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>send_google_chat_message</span>(<span style=color:#a6e22e>env</span>, <span style=color:#a6e22e>message</span>);
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>MESSAGE_TYPE</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;WeworkChat&#39;</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>send_wework_chat_message</span>(<span style=color:#a6e22e>env</span>, <span style=color:#a6e22e>message</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getAndRotateOwners</span>(<span style=color:#a6e22e>env</span>, <span style=color:#a6e22e>type</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>namesString</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>notification_namespace</span>.<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>type</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>names</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>namesString</span>.<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#39;,&#39;</span>);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>names</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>names</span>.<span style=color:#a6e22e>shift</span>());
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>storeNameString</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>names</span>.<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;,&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>notification_namespace</span>.<span style=color:#a6e22e>put</span>(<span style=color:#a6e22e>type</span>, <span style=color:#a6e22e>storeNameString</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>names</span>[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>完整的项目代码放在这个 <a href=https://github.com/guangzhengli/workers-webhook-notification>仓库</a> 👈</p><h2 id=总结>总结</h2><p>回顾整个开发流程，我们能很轻易的感受到 serverless 的易用性和潜力，像类似于 WebHook、数据统计分析、Trigger 及定时任务和 Chat 机器人等功能，借用于 serverless 可以轻易的实现和部署，完成系统的原型设计和想法的闭环。近几年业界也在不断完善 serverless 的开发流程和核心缺陷，例如 <a href=https://www.infoq.com/news/2022/12/aws-lambda-snapstart-accelerate/>JVM 冷启动问题</a>，<a href=https://docs.aws.amazon.com/lambda/latest/dg/telemetry-api.html>serverless 观测和调试增强</a>，数据库 serverless 化如<a href=https://github.com/wundergraph/wunderbase>wunderbase</a>，<a href="https://neon.tech/?utm_campaign=newsletter">Neon</a>，<a href=https://planetscale.com/>planetscale</a>，<a href=https://blog.cloudflare.com/introducing-d1/>D1</a> 等项目。假以时日，当这些问题慢慢解决和优化，serverless 广阔的前景和强大将刷新人们的认知。</p><h2 id=reference>Reference</h2><ol><li><a href=https://sst.dev/chapters/zh/what-is-serverless.html>https://sst.dev/chapters/zh/what-is-serverless.html</a></li><li><a href=https://blog.cloudflare.com/introducing-d1/>https://blog.cloudflare.com/introducing-d1/</a></li><li><a href=https://aws.amazon.com/free/>https://aws.amazon.com/free/</a></li><li><a href=https://azure.microsoft.com/en-us/pricing/free-services/>https://azure.microsoft.com/en-us/pricing/free-services/</a></li><li><a href=https://www.infoq.com/news/2022/12/aws-lambda-snapstart-accelerate/>https://www.infoq.com/news/2022/12/aws-lambda-snapstart-accelerate/</a></li><li><a href=https://github.com/wundergraph/wunderbase>https://github.com/wundergraph/wunderbase</a></li><li><a href=https://www.sqlite.org/serverless.html>https://www.sqlite.org/serverless.html</a></li><li><a href=https://github.com/neondatabase/neon>https://github.com/neondatabase/neon</a></li></ol></section><div class=paginator><a class=prev href=https://guangzhengli.com/blog/zh/the-art-of-logging/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg><span>日志的艺术</span></a>
<a class=next href=https://guangzhengli.com/blog/zh/how-to-integrate-umami-for-free-to-blog-site/><span>如何零成本给博客集成 umami 数据统计分析功能</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div><div class=comments><script>const getTheme=window.localStorage&&window.localStorage.getItem("theme");let theme=getTheme==="dark"?"dark":"light",s=document.createElement("script");s.src="https://giscus.app/client.js",s.setAttribute("data-repo","guangzhengli/blog-comments"),s.setAttribute("data-repo-id","R_kgDOHtsjNw"),s.setAttribute("data-category","Announcements"),s.setAttribute("data-category-id","DIC_kwDOHtsjN84CQr99"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","top"),s.setAttribute("data-theme",theme),s.setAttribute("data-lang","en"),s.setAttribute("data-loading","lazy"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></article></div><footer class=footer><p>&copy; 2023 <a href=https://guangzhengli.com/>GuangzhengLi</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>